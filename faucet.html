<!doctype html>

<h1>ðŸš° $OMID Faucet</h1>
<p>Transfer to: <input type="text" id="transfer_to">
<p><button id="drip">Drip</button>

<script type="module">
    import { createWalletClient, createPublicClient, http, custom, formatEther } from 'https://esm.sh/viem';
    import { polygonAmoy } from 'https://esm.sh/viem/chains';

    export const publicClient = createPublicClient({
        chain: polygonAmoy,
        transport: http()
    })

    const faucetAddr = "0xe5fB30317FA4650544952809d50395C2F5cE7959";

    export const walletClient = createWalletClient({
        chain: polygonAmoy,
        transport: custom(window.ethereum),
    });

    await walletClient.switchChain({ id: polygonAmoy.id })

    const [account] = await walletClient.requestAddresses()
    console.log("Wallet", account);

    const faucetAbi = [{
    "type": "function",
    "name": "drip",
    "inputs": [
      {
        "name": "to",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "lastDrip",
    "inputs": [
      {
        "name": "to",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  }
];

    async function callback() {
        const shareTo = document.getElementById("transfer_to").value;

        const lastDrip = await publicClient.readContract({
  address: faucetAddr,
  abi: faucetAbi,
  functionName: 'lastDrip',
  args: [shareTo],
});

      const now = Math.floor(Date.now() / 1000);
      if (now - lastDrip < 86400) {
        alert("Too soon");
        return;
      }

        const { request } = await publicClient.simulateContract({
            address: faucetAddr,
            abi: faucetAbi,
            functionName: 'drip',
            args: [
                shareTo,
            ],
            account
        })

        const txHash = await walletClient.writeContract(request);        
    }

    document.getElementById("drip").onclick=callback;
</script>

